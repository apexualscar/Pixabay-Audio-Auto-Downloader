// Content script for Pixabay Mass Downloader - Enhanced Web Scraping Version
console.log('Pixabay Mass Downloader content script loaded');

let isContentScriptActive = false;
let scrapingInProgress = false;

// Initialize content script
function initializeContentScript() {
    if (isContentScriptActive) return;
    
    console.log('Initializing Pixabay content script...');
    isContentScriptActive = true;
    
    // Check if we're on a user profile page
    if (window.location.pathname.includes('/users/')) {
        console.log('User profile page detected');
        
        // Add visual indicators that scraping is available
        addScrapingIndicators();
        
        // Listen for messages from background script
        chrome.runtime.onMessage.addListener(handleBackgroundMessage);
        
        // Check available categories
        checkAvailableCategories();
    }
}

function addScrapingIndicators() {
    // Add a subtle indicator that the scraper is active
    const indicator = document.createElement('div');
    indicator.id = 'pixabay-scraper-indicator';
    indicator.innerHTML = `
        <div style="
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4bc24b;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">
            🎵 Scraper Ready
        </div>
    `;
    
    document.body.appendChild(indicator);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        const el = document.getElementById('pixabay-scraper-indicator');
        if (el) {
            el.style.opacity = '0';
            el.style.transition = 'opacity 0.5s ease';
            setTimeout(() => el.remove(), 500);
        }
    }, 3000);
}

function handleBackgroundMessage(message, sender, sendResponse) {
    console.log('Content script received message:', message);
    
    switch (message.action) {
        case 'CHECK_CATEGORIES':
            checkAvailableCategories();
            break;
        case 'SCRAPE_CATEGORY':
            scrapeCategoryFromCurrentPage(message.category, message.username);
            break;
    }
}

async function checkAvailableCategories() {
    console.log('Checking available content categories...');
    
    const availableCategories = {
        photos: 0,
        illustrations: 0,
        vectors: 0,
        videos: 0,
        music: 0,
        'sound-effects': 0,
        gifs: 0
    };
    
    try {
        // Look for navigation tabs or category indicators
        const navTabs = document.querySelectorAll('nav a, .nav-tabs a, [role="tab"], .tab, .filter-tab');
        console.log(`Found ${navTabs.length} potential navigation elements`);
        
        navTabs.forEach(tab => {
            const text = (tab.textContent || '').toLowerCase();
            const href = tab.href || '';
            
            // Check for category indicators and counts
            if (text.includes('photo') || href.includes('/photos') || text.includes('image')) {
                const count = extractCountFromElement(tab);
                availableCategories.photos = count;
            } else if (text.includes('illustration') || href.includes('/illustrations')) {
                const count = extractCountFromElement(tab);
                availableCategories.illustrations = count;
            } else if (text.includes('vector') || href.includes('/vectors')) {
                const count = extractCountFromElement(tab);
                availableCategories.vectors = count;
            } else if (text.includes('video') || href.includes('/videos')) {
                const count = extractCountFromElement(tab);
                availableCategories.videos = count;
            } else if (text.includes('music') || href.includes('/music')) {
                const count = extractCountFromElement(tab);
                availableCategories.music = count;
            } else if (text.includes('sound') || href.includes('/sound-effects')) {
                const count = extractCountFromElement(tab);
                availableCategories['sound-effects'] = count;
            } else if (text.includes('gif') || href.includes('/gifs')) {
                const count = extractCountFromElement(tab);
                availableCategories.gifs = count;
            }
        });
        
        // If we're currently viewing a category, count items on this page
        const currentCategory = getCurrentCategoryFromUrl();
        if (currentCategory) {
            const itemCount = await countItemsOnCurrentPage();
            if (itemCount > 0) {
                availableCategories[currentCategory] = itemCount;
            }
        }
        
        console.log('Available categories:', availableCategories);
        
        // Send category info to background script
        chrome.runtime.sendMessage({
            action: 'CATEGORIES_CHECKED',
            categories: availableCategories
        });
        
    } catch (error) {
        console.error('Error checking categories:', error);
    }
}

function extractCountFromElement(element) {
    // Look for numbers in the element or nearby elements
    const text = element.textContent || '';
    const numbers = text.match(/\d+/g);
    if (numbers && numbers.length > 0) {
        return parseInt(numbers[numbers.length - 1]); // Take the last number found
    }
    
    // Look for count in adjacent elements
    const parent = element.parentElement;
    if (parent) {
        const parentText = parent.textContent || '';
        const parentNumbers = parentText.match(/\d+/g);
        if (parentNumbers && parentNumbers.length > 0) {
            return parseInt(parentNumbers[parentNumbers.length - 1]);
        }
    }
    
    return 0;
}

function getCurrentCategoryFromUrl() {
    const path = window.location.pathname;
    if (path.includes('/illustrations')) return 'illustrations';
    if (path.includes('/vectors')) return 'vectors';
    if (path.includes('/videos')) return 'videos';
    if (path.includes('/music')) return 'music';
    if (path.includes('/sound-effects')) return 'sound-effects';
    if (path.includes('/gifs')) return 'gifs';
    if (path.includes('/users/') && !path.includes('/', path.lastIndexOf('/users/') + 7)) return 'photos';
    return null;
}

async function countItemsOnCurrentPage() {
    // Wait a moment for content to load
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Modern Pixabay selectors (updated for 2024)
    const selectors = [
        '[data-testid="image-grid"] > div',
        '.media-grid > div',
        '.grid-container > div',
        '.image-container',
        '.media-item',
        'article[data-id]',
        '.result-item',
        '[data-image-id]'
    ];
    
    let maxCount = 0;
    for (const selector of selectors) {
        const elements = document.querySelectorAll(selector);
        console.log(`Selector "${selector}" found ${elements.length} items`);
        maxCount = Math.max(maxCount, elements.length);
    }
    
    return maxCount;
}

async function scrapeCategoryFromCurrentPage(category, username) {
    if (scrapingInProgress) {
        console.log('Scraping already in progress');
        return;
    }
    
    scrapingInProgress = true;
    
    try {
        console.log(`Starting to scrape ${category} content for ${username}`);
        
        // Show scraping indicator
        showScrapingProgress(`Scanning ${category} content...`);
        
        // Navigate to category page if needed
        const shouldNavigate = await ensureCorrectCategoryPage(category, username);
        if (shouldNavigate) return; // Will continue after navigation
        
        // Wait for page to load completely
        await waitForPageLoad();
        
        // Scroll to load all content
        await scrollToLoadAll();
        
        // Extract content items with progress updates
        const contentItems = await extractContentItemsWithProgress(category);
        
        console.log(`Successfully extracted ${contentItems.length} ${category} items`);
        
        // Send results back to background script
        chrome.runtime.sendMessage({
            action: 'CONTENT_SCRAPED',
            category: category,
            username: username,
            items: contentItems
        });
        
        hideScrapingProgress();
        
    } catch (error) {
        console.error('Error scraping content:', error);
        hideScrapingProgress();
        chrome.runtime.sendMessage({
            action: 'SCRAPING_ERROR',
            error: error.message
        });
    } finally {
        scrapingInProgress = false;
    }
}

async function ensureCorrectCategoryPage(category, username) {
    const currentCategory = getCurrentCategoryFromUrl();
    
    if (currentCategory === category) {
        console.log(`Already on ${category} page`);
        return false;
    }
    
    // Navigate to the correct category page
    const categoryUrl = getCategoryUrl(category, username);
    console.log(`Navigating to ${categoryUrl}`);
    showScrapingProgress(`Navigating to ${category} page...`);
    
    window.location.href = categoryUrl;
    return true; // Indicates navigation occurred
}

function getCategoryUrl(category, username) {
    const categoryPaths = {
        'photos': '?tab=all',
        'illustrations': 'illustrations/?tab=all',
        'vectors': 'vectors/?tab=all',
        'videos': 'videos/?tab=all',
        'music': 'music/?tab=all',
        'sound-effects': 'sound-effects/?tab=all',
        'gifs': 'gifs/?tab=all'
    };
    
    const path = categoryPaths[category] || '?tab=all';
    return `https://pixabay.com/users/${username}/${path}&order=latest`;
}

function waitForPageLoad() {
    return new Promise((resolve) => {
        if (document.readyState === 'complete') {
            setTimeout(resolve, 2000); // Extra delay for dynamic content
        } else {
            window.addEventListener('load', () => {
                setTimeout(resolve, 2000);
            });
        }
    });
}

async function scrollToLoadAll() {
    console.log('Scrolling to load all content...');
    
    return new Promise((resolve) => {
        let scrollCount = 0;
        let lastItemCount = 0;
        let stableCount = 0;
        const maxScrolls = 100;
        
        function scrollStep() {
            // Count current items
            const currentItemCount = countItemsOnCurrentPage();
            
            // Check if new items loaded
            if (currentItemCount === lastItemCount) {
                stableCount++;
            } else {
                stableCount = 0;
                lastItemCount = currentItemCount;
                console.log(`Found ${currentItemCount} items after scroll ${scrollCount}`);
                
                // Update progress
                showScrapingProgress(`Loading content... Found ${currentItemCount} items`);
            }
            
            // Stop if no new items for 3 consecutive scrolls or max scrolls reached
            if (stableCount >= 3 || scrollCount >= maxScrolls) {
                console.log(`Scrolling complete. Final count: ${currentItemCount} items`);
                window.scrollTo(0, 0); // Scroll back to top
                setTimeout(resolve, 2000);
                return;
            }
            
            // Scroll down
            window.scrollBy(0, 1500);
            scrollCount++;
            
            setTimeout(scrollStep, 1500); // Wait between scrolls
        }
        
        scrollStep();
    });
}

async function extractContentItemsWithProgress(category) {
    console.log(`Extracting ${category} items...`);
    showScrapingProgress('Analyzing found content...');
    
    const items = [];
    
    // Updated selectors for modern Pixabay (2024)
    const selectors = {
        // Main content containers
        containers: [
            '[data-testid="image-grid"] > div',
            '.media-grid > div',
            '.grid-container > div',
            'article[data-id]',
            '[data-image-id]',
            '.result-item',
            '.media-item'
        ],
        // Links to item pages
        itemLinks: [
            'a[href*="/photos/"]',
            'a[href*="/illustrations/"]',
            'a[href*="/vectors/"]',
            'a[href*="/videos/"]',
            'a[href*="/music/"]',
            'a[href*="/sound-effects/"]',
            'a[href*="/gifs/"]'
        ],
        // Images
        images: [
            'img[src*="pixabay"]',
            'img[data-src*="pixabay"]',
            'img[srcset*="pixabay"]'
        ]
    };
    
    // Find containers using multiple strategies
    let containers = [];
    for (const selector of selectors.containers) {
        const found = document.querySelectorAll(selector);
        if (found.length > containers.length) {
            containers = Array.from(found);
            console.log(`Using selector "${selector}" - found ${containers.length} containers`);
        }
    }
    
    if (containers.length === 0) {
        // Fallback: find by item links
        console.log('No containers found, trying item links...');
        const links = document.querySelectorAll(selectors.itemLinks.join(', '));
        containers = Array.from(links).map(link => link.closest('div, article') || link);
        console.log(`Found ${containers.length} items via links`);
    }
    
    if (containers.length === 0) {
        // Final fallback: find images directly
        console.log('No containers found, extracting from images...');
        const images = document.querySelectorAll(selectors.images.join(', '));
        
        Array.from(images).forEach((img, index) => {
            if (img.src && img.src.includes('pixabay.com') && img.src.includes('_')) {
                const item = extractItemFromImage(img, index, category);
                if (item) {
                    items.push(item);
                    if (items.length % 10 === 0) {
                        showScrapingProgress(`Extracted ${items.length} items...`);
                    }
                }
            }
        });
        
        return items;
    }
    
    // Process containers
    console.log(`Processing ${containers.length} containers...`);
    
    containers.forEach((container, index) => {
        try {
            const item = extractItemFromContainer(container, index, category);
            if (item) {
                items.push(item);
                
                // Update progress every 10 items
                if (items.length % 10 === 0) {
                    showScrapingProgress(`Extracted ${items.length} items...`);
                }
            }
        } catch (error) {
            console.error(`Error processing container ${index}:`, error);
        }
    });
    
    console.log(`Successfully extracted ${items.length} ${category} items`);
    return items;
}

function extractItemFromContainer(container, index, category) {
    try {
        // Find the main link
        const itemLink = container.querySelector('a[href*="pixabay.com"]');
        let itemUrl = itemLink ? itemLink.href : '';
        
        // Extract ID from URL or container
        let itemId = '';
        if (itemUrl) {
            const idMatch = itemUrl.match(/\/(\d+)/);
            itemId = idMatch ? idMatch[1] : '';
        }
        
        if (!itemId) {
            itemId = container.getAttribute('data-id') || 
                    container.getAttribute('data-image-id') ||
                    `${category}_${index}`;
        }
        
        // Find image
        const img = container.querySelector('img');
        let previewUrl = '';
        let title = '';
        
        if (img) {
            previewUrl = img.src || img.getAttribute('data-src') || '';
            title = img.alt || img.title || '';
        }
        
        // Generate download URL from preview URL
        let downloadUrl = '';
        if (previewUrl && previewUrl.includes('pixabay.com')) {
            // Convert preview URL to full-size URL
            downloadUrl = previewUrl
                .replace(/_\d+\./, '_1280.')  // Replace size with 1280
                .replace(/\/\d+_\d+_\d+\//, '/1920-1280/') // Some URLs have different format
                .replace('webformatURL', 'largeImageURL');
        }
        
        if (!downloadUrl) {
            downloadUrl = previewUrl; // Fallback to preview
        }
        
        // Clean up title
        if (!title && itemLink) {
            title = itemLink.getAttribute('title') || 
                   itemLink.textContent?.trim() || 
                   `${category}_${itemId}`;
        }
        
        if (itemId && (downloadUrl || previewUrl)) {
            return {
                id: itemId,
                title: title.trim() || `${category}_${itemId}`,
                downloadUrl: downloadUrl,
                previewUrl: previewUrl,
                category: category,
                itemUrl: itemUrl
            };
        }
        
    } catch (error) {
        console.error(`Error extracting item ${index}:`, error);
    }
    
    return null;
}

function extractItemFromImage(img, index, category) {
    try {
        const previewUrl = img.src || img.getAttribute('data-src') || '';
        if (!previewUrl || !previewUrl.includes('pixabay.com')) return null;
        
        // Extract ID from image URL
        const idMatch = previewUrl.match(/\/(\d+)[-_]/);
        const itemId = idMatch ? idMatch[1] : `${category}_${index}`;
        
        // Generate download URL
        const downloadUrl = previewUrl
            .replace(/_\d+\./, '_1280.')
            .replace(/\/\d+_\d+_\d+\//, '/1920-1280/');
        
        const title = img.alt || img.title || `${category}_${itemId}`;
        
        return {
            id: itemId,
            title: title.trim(),
            downloadUrl: downloadUrl,
            previewUrl: previewUrl,
            category: category
        };
        
    } catch (error) {
        console.error(`Error extracting image item ${index}:`, error);
        return null;
    }
}

function showScrapingProgress(message) {
    let progressEl = document.getElementById('pixabay-scraping-progress');
    
    if (!progressEl) {
        progressEl = document.createElement('div');
        progressEl.id = 'pixabay-scraping-progress';
        progressEl.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(75, 194, 75, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            backdrop-filter: blur(10px);
            max-width: 400px;
            text-align: center;
        `;
        document.body.appendChild(progressEl);
    }
    
    progressEl.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; flex-direction: column;">
            <div style="
                width: 24px;
                height: 24px;
                border: 3px solid rgba(255,255,255,0.3);
                border-top: 3px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            "></div>
            <div>${message}</div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
}

function hideScrapingProgress() {
    const progressEl = document.getElementById('pixabay-scraping-progress');
    if (progressEl) {
        progressEl.remove();
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeContentScript);
} else {
    initializeContentScript();
}

// Handle page navigation (for single-page app behavior)
let currentUrl = window.location.href;
setInterval(() => {
    if (window.location.href !== currentUrl) {
        currentUrl = window.location.href;
        isContentScriptActive = false;
        setTimeout(initializeContentScript, 1000);
    }
}, 2000);