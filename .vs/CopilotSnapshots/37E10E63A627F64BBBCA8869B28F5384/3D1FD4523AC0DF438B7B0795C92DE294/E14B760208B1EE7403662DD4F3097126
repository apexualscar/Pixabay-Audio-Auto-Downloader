// Popup script for Pixabay Mass Downloader - Enhanced Web Scraping Version
let currentUsername = null;
let currentUserInfo = null;
let isDownloading = false;
let isPaused = false;
let scannedItems = [];
let availableCategories = {};

// Initialize immediately when DOM is ready
document.addEventListener('DOMContentLoaded', initializePopup);

async function initializePopup() {
    try {
        // Quick status check first
        await updateStatus();
        
        // Check current page - no API key needed for scraping
        await checkCurrentPage();
        
        // Setup event listeners
        setupEventListeners();
        
    } catch (error) {
        console.error('Error initializing popup:', error);
        updateStatusMessage('❌', 'Error loading extension', 'error');
    }
}

function setupEventListeners() {
    // Category download buttons
    document.getElementById('photosBtn').addEventListener('click', () => startCategoryDownload('photos'));
    document.getElementById('illustrationsBtn').addEventListener('click', () => startCategoryDownload('illustrations'));
    document.getElementById('vectorsBtn').addEventListener('click', () => startCategoryDownload('vectors'));
    document.getElementById('videosBtn').addEventListener('click', () => startCategoryDownload('videos'));
    document.getElementById('musicBtn').addEventListener('click', () => startCategoryDownload('music'));
    document.getElementById('soundEffectsBtn').addEventListener('click', () => startCategoryDownload('sound-effects'));
    document.getElementById('gifsBtn').addEventListener('click', () => startCategoryDownload('gifs'));
    
    // Download control buttons
    document.getElementById('pauseBtn').addEventListener('click', pauseDownload);
    document.getElementById('resumeBtn').addEventListener('click', resumeDownload);
    document.getElementById('cancelBtn').addEventListener('click', cancelDownload);
    
    // User profile interactions
    document.getElementById('followBtn').addEventListener('click', followUser);
    
    // Footer buttons
    document.getElementById('refreshBtn').addEventListener('click', (e) => {
        e.preventDefault();
        refreshData();
    });
    
    document.getElementById('clearListBtn').addEventListener('click', (e) => {
        e.preventDefault();
        clearScannedItems();
    });
}

async function updateStatus() {
    updateStatusMessage('⏳', 'Checking status...', '');
}

async function checkCurrentPage() {
    try {
        const [activeTab] = await chrome.tabs.query({ active: true, currentWindow: true });
        
        if (!activeTab || !activeTab.url) {
            updateStatusMessage('ℹ️', 'No active tab detected', 'warning');
            return;
        }
        
        console.log('Current tab URL:', activeTab.url);
        
        if (activeTab.url.includes('pixabay.com/users/')) {
            currentUsername = extractUsernameFromUrl(activeTab.url);
            if (currentUsername) {
                // Get user info from the page itself
                chrome.runtime.sendMessage({
                    action: 'GET_USER_INFO',
                    tabId: activeTab.id
                });
                
                // Check available categories
                chrome.runtime.sendMessage({
                    action: 'CHECK_CATEGORIES',
                    tabId: activeTab.id
                });
                
                showDownloadSection(currentUsername);
                updateStatusMessage('✅', `Ready to scrape content from: ${currentUsername}`, 'success');
            } else {
                updateStatusMessage('⚠️', 'Unable to detect username', 'warning');
            }
        } else if (activeTab.url.includes('pixabay.com')) {
            updateStatusMessage('⚠️', 'Navigate to a user profile page to start scraping', 'warning');
        } else {
            updateStatusMessage('ℹ️', 'Visit a Pixabay user profile to begin scraping', '');
        }
        
    } catch (error) {
        console.error('Error checking current page:', error);
        updateStatusMessage('❌', 'Error checking page', 'error');
    }
}

function extractUsernameFromUrl(url) {
    try {
        const match = url.match(/\/users\/([^\/\?]+)/);
        const username = match ? decodeURIComponent(match[1]) : null;
        console.log('Extracted username:', username);
        return username;
    } catch (error) {
        console.error('Error extracting username:', error);
        return null;
    }
}

function updateStatusMessage(icon, message, type = '') {
    document.getElementById('statusIcon').textContent = icon;
    document.getElementById('statusMessage').textContent = message;
    
    const statusSection = document.querySelector('.status-section');
    statusSection.className = `status-section ${type}`;
}

function showDownloadSection(username) {
    document.getElementById('downloadSection').classList.remove('hidden');
}

function showUserInfo(userInfo) {
    currentUserInfo = userInfo;
    document.getElementById('userInfoSection').classList.remove('hidden');
    
    // Update user avatar
    const avatarEl = document.getElementById('userAvatar');
    if (userInfo.userImageURL) {
        avatarEl.innerHTML = `<img src="${userInfo.userImageURL}" alt="${userInfo.username}">`;
    } else {
        avatarEl.innerHTML = '👤';
    }
    
    // Update user name and profile link
    document.getElementById('userName').textContent = userInfo.username;
    const profileLink = document.getElementById('userProfileLink');
    profileLink.href = userInfo.profileUrl;
    profileLink.textContent = 'View Profile';
    
    console.log('User info displayed:', userInfo);
}

function updateCategoryAvailability(categories) {
    availableCategories = categories;
    console.log('Updated category availability:', categories);
    
    // Update button states and counts
    Object.entries(categories).forEach(([category, count]) => {
        const btnId = category === 'sound-effects' ? 'soundEffectsBtn' : category + 'Btn';
        const countId = category === 'sound-effects' ? 'soundEffectsCount' : category + 'Count';
        
        const btn = document.getElementById(btnId);
        const countEl = document.getElementById(countId);
        
        if (btn && countEl) {
            countEl.textContent = count > 0 ? count : '0';
            
            // Disable button if no content available
            if (count === 0) {
                btn.disabled = true;
                btn.title = `No ${category} content found for this user`;
            } else {
                btn.disabled = false;
                btn.title = `Download ${count} ${category} items`;
            }
        }
    });
}

async function startCategoryDownload(category) {
    if (!currentUsername || isDownloading) {
        console.log('Cannot start download:', { currentUsername, isDownloading });
        return;
    }
    
    // Check if category has content
    if (availableCategories[category] === 0) {
        updateStatusMessage('⚠️', `No ${category} content found for ${currentUsername}`, 'warning');
        return;
    }
    
    isDownloading = true;
    isPaused = false;
    
    const categoryBtn = document.querySelector(`[data-category="${category}"]`);
    const originalText = categoryBtn.innerHTML;
    
    try {
        console.log(`Starting ${category} download from ${currentUsername}`);
        
        // Clear previous results
        clearScannedItems();
        
        // Show progress and controls
        showProgress();
        showDownloadControls();
        categoryBtn.innerHTML = '<div class="spinner"></div> Scanning...';
        categoryBtn.disabled = true;
        
        // Disable all category buttons
        disableCategoryButtons(true);
        
        // Get current tab
        const [activeTab] = await chrome.tabs.query({ active: true, currentWindow: true });
        
        console.log('Sending scrape request to background script...');
        
        // Send message to background script to start scraping
        const response = await chrome.runtime.sendMessage({
            action: 'START_SCRAPE_DOWNLOAD',
            category: category,
            username: currentUsername,
            tabId: activeTab.id
        });
        
        console.log('Background script response:', response);
        updateStatusMessage('🔍', `Scanning ${category} content from ${currentUsername}...`, 'success');
        
    } catch (error) {
        console.error('Download error:', error);
        updateStatusMessage('❌', `Download failed: ${error.message}`, 'error');
        hideProgress();
        hideDownloadControls();
        
        // Reset button
        categoryBtn.innerHTML = originalText;
        categoryBtn.disabled = false;
        disableCategoryButtons(false);
        isDownloading = false;
    }
}

async function pauseDownload() {
    try {
        isPaused = true;
        await chrome.runtime.sendMessage({ action: 'PAUSE_DOWNLOAD' });
        
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('resumeBtn').disabled = false;
        
        updateStatusMessage('⏸️', 'Download paused', 'warning');
    } catch (error) {
        console.error('Error pausing download:', error);
    }
}

async function resumeDownload() {
    try {
        isPaused = false;
        await chrome.runtime.sendMessage({ action: 'RESUME_DOWNLOAD' });
        
        document.getElementById('pauseBtn').disabled = false;
        document.getElementById('resumeBtn').disabled = true;
        
        updateStatusMessage('▶️', 'Download resumed', 'success');
    } catch (error) {
        console.error('Error resuming download:', error);
    }
}

async function cancelDownload() {
    try {
        await chrome.runtime.sendMessage({ action: 'CANCEL_DOWNLOAD' });
        
        updateStatusMessage('❌', 'Download canceled', 'error');
        hideProgress();
        hideDownloadControls();
        resetCategoryButtons();
        disableCategoryButtons(false);
        isDownloading = false;
        isPaused = false;
    } catch (error) {
        console.error('Error canceling download:', error);
    }
}

function followUser() {
    if (currentUserInfo && currentUserInfo.profileUrl) {
        chrome.tabs.create({ url: currentUserInfo.profileUrl });
    }
}

async function refreshData() {
    clearScannedItems();
    availableCategories = {};
    await checkCurrentPage();
}

function clearScannedItems() {
    scannedItems = [];
    updateItemsList();
    document.getElementById('itemsList').classList.add('hidden');
}

function showItemsList(items) {
    scannedItems = items;
    updateItemsList();
    document.getElementById('itemsList').classList.remove('hidden');
}

function updateItemsList() {
    const container = document.getElementById('itemsContainer');
    const countEl = document.getElementById('itemsCount');
    
    countEl.textContent = `${scannedItems.length} items`;
    
    if (scannedItems.length === 0) {
        container.innerHTML = '<div class="empty-state">No items scanned yet. Click a category button to start scanning.</div>';
        return;
    }
    
    container.innerHTML = scannedItems.map((item, index) => `
        <div class="item-entry">
            <img class="item-preview" src="${item.previewUrl}" alt="${item.title}" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik0xNiA4QzEyLjY5IDggMTAgMTAuNjkgMTAgMTRDMTAgMTcuMzEgMTIuNjkgMjAgMTYgMjBDMTkuMzEgMjAgMjIgMTcuMzEgMjIgMTRDMjIgMTAuNjkgMTkuMzEgOCAxNiA4WiIgZmlsbD0iIzZDNzU3RCIvPgo8L3N2Zz4K'">
            <div class="item-info">
                <div class="item-title">${item.title}</div>
                <div class="item-id">ID: ${item.id}</div>
            </div>
        </div>
    `).join('');
}

function showProgress() {
    document.getElementById('progressSection').classList.remove('hidden');
    updateProgress(0, 0);
}

function hideProgress() {
    document.getElementById('progressSection').classList.add('hidden');
}

function showDownloadControls() {
    document.getElementById('downloadControls').classList.remove('hidden');
    document.getElementById('pauseBtn').disabled = false;
    document.getElementById('resumeBtn').disabled = true;
    document.getElementById('cancelBtn').disabled = false;
}

function hideDownloadControls() {
    document.getElementById('downloadControls').classList.add('hidden');
}

function disableCategoryButtons(disabled) {
    const buttons = document.querySelectorAll('.category-btn');
    buttons.forEach(btn => {
        if (!disabled) {
            // Only enable if category has content
            const category = btn.dataset.category;
            btn.disabled = availableCategories[category] === 0;
        } else {
            btn.disabled = disabled;
        }
    });
}

function updateProgress(current, total) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    if (total > 0) {
        const percentage = (current / total) * 100;
        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${current} / ${total} downloaded (${percentage.toFixed(1)}%)`;
    } else {
        progressFill.style.width = '0%';
        progressText.textContent = 'Scanning for content...';
    }
}

// Listen for messages from background script
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
    console.log('Received message in popup:', message);
    
    switch (message.action) {
        case 'USER_INFO_RECEIVED':
            if (message.userInfo) {
                showUserInfo(message.userInfo);
            }
            break;
            
        case 'CATEGORIES_CHECKED':
            updateCategoryAvailability(message.categories);
            break;
            
        case 'CONTENT_SCRAPED':
            if (message.items && message.items.length > 0) {
                showItemsList(message.items);
                updateStatusMessage('✅', `Found ${message.items.length} ${message.category} items`, 'success');
            } else {
                updateStatusMessage('⚠️', `No ${message.category} items found`, 'warning');
            }
            break;
            
        case 'DOWNLOAD_STARTED':
            updateStatusMessage('🚀', `Downloading ${message.category} from ${message.username}...`, 'success');
            break;
            
        case 'UPDATE_PROGRESS':
            updateProgress(message.current, message.total);
            updateStatusMessage('📥', `Downloaded ${message.current}/${message.total} files`, 'success');
            break;
            
        case 'DOWNLOAD_COMPLETE':
            updateStatusMessage('✅', `Download complete! ${message.count} files downloaded.`, 'success');
            hideProgress();
            hideDownloadControls();
            resetCategoryButtons();
            disableCategoryButtons(false);
            isDownloading = false;
            isPaused = false;
            break;
            
        case 'DOWNLOAD_CANCELED':
            updateStatusMessage('❌', `Download canceled. ${message.count || 0} files downloaded.`, 'error');
            hideProgress();
            hideDownloadControls();
            resetCategoryButtons();
            disableCategoryButtons(false);
            isDownloading = false;
            isPaused = false;
            break;
            
        case 'DOWNLOAD_PAUSED':
            updateStatusMessage('⏸️', 'Download paused', 'warning');
            break;
            
        case 'DOWNLOAD_RESUMED':
            updateStatusMessage('▶️', 'Download resumed', 'success');
            break;
            
        case 'DOWNLOAD_ERROR':
            console.error('Download error from background:', message.error);
            updateStatusMessage('❌', `Error: ${message.error}`, 'error');
            hideProgress();
            hideDownloadControls();
            resetCategoryButtons();
            disableCategoryButtons(false);
            isDownloading = false;
            isPaused = false;
            break;
            
        case 'SCRAPING_ERROR':
            console.error('Scraping error from background:', message.error);
            updateStatusMessage('❌', `Scanning failed: ${message.error}`, 'error');
            resetCategoryButtons();
            disableCategoryButtons(false);
            isDownloading = false;
            break;
    }
});

function resetCategoryButtons() {
    // Reset all category buttons
    const categoryLabels = {
        'photos': '📷 Photos',
        'illustrations': '🎨 Illustrations',
        'vectors': '📐 Vectors',
        'videos': '🎬 Videos',
        'music': '🎵 Music',
        'sound-effects': '🔊 Sound FX',
        'gifs': '🎞️ GIFs'
    };
    
    Object.entries(categoryLabels).forEach(([category, label]) => {
        const btnId = category === 'sound-effects' ? 'soundEffectsBtn' : category + 'Btn';
        const countId = category === 'sound-effects' ? 'soundEffectsCount' : category + 'Count';
        
        const btn = document.getElementById(btnId);
        const countEl = document.getElementById(countId);
        
        if (btn && countEl) {
            const count = availableCategories[category] || 0;
            btn.innerHTML = `${label} <span class="count">${count}</span>`;
            btn.disabled = count === 0;
        }
    });
}

// Refresh status when popup is opened
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        setTimeout(checkCurrentPage, 100);
    }
});

// Add debugging
console.log('Popup script (Enhanced Web Scraper) loaded successfully');