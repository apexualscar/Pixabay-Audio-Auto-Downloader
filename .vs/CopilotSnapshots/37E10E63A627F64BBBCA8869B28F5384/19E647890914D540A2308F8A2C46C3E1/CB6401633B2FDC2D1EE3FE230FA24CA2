// Content script for Pixabay Mass Downloader - Web Scraping Version
console.log('Pixabay Mass Downloader content script loaded');

let isContentScriptActive = false;
let scrapingInProgress = false;

// Initialize content script
function initializeContentScript() {
    if (isContentScriptActive) return;
    
    console.log('Initializing Pixabay content script...');
    isContentScriptActive = true;
    
    // Check if we're on a user profile page
    if (window.location.pathname.includes('/users/')) {
        console.log('User profile page detected');
        
        // Add visual indicators that scraping is available
        addScrapingIndicators();
        
        // Listen for messages from background script
        chrome.runtime.onMessage.addListener(handleBackgroundMessage);
    }
}

function addScrapingIndicators() {
    // Add a subtle indicator that the scraper is active
    const indicator = document.createElement('div');
    indicator.id = 'pixabay-scraper-indicator';
    indicator.innerHTML = `
        <div style="
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4bc24b;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">
            🎵 Scraper Ready
        </div>
    `;
    
    document.body.appendChild(indicator);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        const el = document.getElementById('pixabay-scraper-indicator');
        if (el) {
            el.style.opacity = '0';
            el.style.transition = 'opacity 0.5s ease';
            setTimeout(() => el.remove(), 500);
        }
    }, 3000);
}

function handleBackgroundMessage(message, sender, sendResponse) {
    console.log('Content script received message:', message);
    
    switch (message.action) {
        case 'SCRAPE_CONTENT':
            scrapeContent(message.category, message.username);
            break;
        case 'NAVIGATE_TO_CATEGORY':
            navigateToCategory(message.category, message.username);
            break;
        case 'EXTRACT_DOWNLOAD_LINKS':
            extractDownloadLinks(message.category);
            break;
    }
}

async function scrapeContent(category, username) {
    if (scrapingInProgress) {
        console.log('Scraping already in progress');
        return;
    }
    
    scrapingInProgress = true;
    
    try {
        console.log(`Starting to scrape ${category} content for ${username}`);
        
        // Show scraping indicator
        showScrapingProgress(`Scraping ${category}...`);
        
        // First, navigate to the correct category page if needed
        const categoryUrl = getCategoryUrl(category, username);
        
        if (!window.location.href.includes(categoryUrl)) {
            console.log(`Navigating to ${categoryUrl}`);
            showScrapingProgress(`Navigating to ${category} page...`);
            window.location.href = categoryUrl;
            return; // Page will reload, script will continue after navigation
        }
        
        // Wait for page to load completely
        await waitForPageLoad();
        
        // Scroll to load all content
        await scrollToLoadAll();
        
        // Extract content items
        const contentItems = await extractContentItems(category);
        
        console.log(`Found ${contentItems.length} ${category} items`);
        
        // Send results back to background script
        chrome.runtime.sendMessage({
            action: 'CONTENT_SCRAPED',
            category: category,
            username: username,
            items: contentItems
        });
        
        hideScrapingProgress();
        
    } catch (error) {
        console.error('Error scraping content:', error);
        hideScrapingProgress();
        chrome.runtime.sendMessage({
            action: 'SCRAPING_ERROR',
            error: error.message
        });
    } finally {
        scrapingInProgress = false;
    }
}

function getCategoryUrl(category, username) {
    const categoryPaths = {
        'photos': '',
        'illustrations': 'illustrations/',
        'vectors': 'vectors/',
        'videos': 'videos/',
        'music': 'music/',
        'sound-effects': 'sound-effects/',
        'gifs': 'gifs/'
    };
    
    const path = categoryPaths[category] || '';
    return `https://pixabay.com/users/${username}/${path}`;
}

function waitForPageLoad() {
    return new Promise((resolve) => {
        if (document.readyState === 'complete') {
            setTimeout(resolve, 1000); // Extra delay for dynamic content
        } else {
            window.addEventListener('load', () => {
                setTimeout(resolve, 1000);
            });
        }
    });
}

async function scrollToLoadAll() {
    console.log('Scrolling to load all content...');
    
    return new Promise((resolve) => {
        let scrollCount = 0;
        const maxScrolls = 50; // Prevent infinite scrolling
        
        function scrollStep() {
            const scrollHeight = document.documentElement.scrollHeight;
            const scrollTop = document.documentElement.scrollTop;
            const clientHeight = document.documentElement.clientHeight;
            
            // Scroll down
            window.scrollBy(0, 1000);
            scrollCount++;
            
            // Check if we've reached the bottom or max scrolls
            if (scrollTop + clientHeight >= scrollHeight - 100 || scrollCount >= maxScrolls) {
                console.log(`Scrolling complete. Total scrolls: ${scrollCount}`);
                // Scroll back to top
                window.scrollTo(0, 0);
                setTimeout(resolve, 2000); // Wait for final content to load
            } else {
                setTimeout(scrollStep, 1000); // Wait 1 second between scrolls
            }
        }
        
        scrollStep();
    });
}

async function extractContentItems(category) {
    console.log(`Extracting ${category} items...`);
    
    const items = [];
    
    // Common selectors for different content types
    const selectors = {
        container: [
            'div[data-testid="media-item"]',
            '.item',
            '.media-item',
            '.photo-item',
            '.video-item',
            '.audio-item',
            'article',
            '.grid-item'
        ],
        downloadButton: [
            'a[href*="/download/"]',
            'button[aria-label*="download"]',
            '.download-btn',
            'a[data-track-action="download"]',
            'button[data-track-action="download"]',
            'a[href*="download"]'
        ],
        image: [
            'img[src*="pixabay"]',
            'img[data-src*="pixabay"]',
            'img'
        ],
        title: [
            'img[alt]',
            '.title',
            'h3',
            '.item-title',
            '.media-title'
        ]
    };
    
    // Find all content containers
    let containers = [];
    for (const selector of selectors.container) {
        containers = document.querySelectorAll(selector);
        if (containers.length > 0) {
            console.log(`Found ${containers.length} items using selector: ${selector}`);
            break;
        }
    }
    
    if (containers.length === 0) {
        console.log('No content containers found, trying alternative approach...');
        // Fallback: look for images directly
        const images = document.querySelectorAll('img[src*="pixabay"], img[data-src*="pixabay"]');
        console.log(`Found ${images.length} images as fallback`);
        
        images.forEach((img, index) => {
            if (img.src && img.src.includes('pixabay')) {
                const item = extractItemFromImage(img, index, category);
                if (item) items.push(item);
            }
        });
    } else {
        // Process each container
        containers.forEach((container, index) => {
            const item = extractItemFromContainer(container, index, category, selectors);
            if (item) items.push(item);
        });
    }
    
    console.log(`Extracted ${items.length} ${category} items`);
    return items;
}

function extractItemFromContainer(container, index, category, selectors) {
    try {
        // Find download button
        let downloadUrl = '';
        for (const selector of selectors.downloadButton) {
            const downloadBtn = container.querySelector(selector);
            if (downloadBtn) {
                downloadUrl = downloadBtn.href || downloadBtn.getAttribute('data-href') || '';
                if (downloadUrl) break;
            }
        }
        
        // Find image/preview
        let previewUrl = '';
        for (const selector of selectors.image) {
            const img = container.querySelector(selector);
            if (img) {
                previewUrl = img.src || img.getAttribute('data-src') || '';
                if (previewUrl && previewUrl.includes('pixabay')) break;
            }
        }
        
        // Find title
        let title = '';
        for (const selector of selectors.title) {
            const titleEl = container.querySelector(selector);
            if (titleEl) {
                title = titleEl.alt || titleEl.textContent || titleEl.innerText || '';
                if (title.trim()) break;
            }
        }
        
        // Extract ID from various sources
        let itemId = container.id || 
                    container.getAttribute('data-id') ||
                    extractIdFromUrl(downloadUrl || previewUrl) ||
                    `${category}_${index}`;
        
        // Use preview URL as download URL if no direct download found
        if (!downloadUrl && previewUrl) {
            downloadUrl = previewUrl.replace('_150.', '_640.'); // Try to get larger version
        }
        
        if (downloadUrl || previewUrl) {
            return {
                id: itemId,
                title: title.trim() || `${category}_${itemId}`,
                downloadUrl: downloadUrl,
                previewUrl: previewUrl,
                category: category
            };
        }
    } catch (error) {
        console.error(`Error extracting item ${index}:`, error);
    }
    
    return null;
}

function extractItemFromImage(img, index, category) {
    try {
        const downloadUrl = img.src.replace('_150.', '_1280.').replace('_640.', '_1280.'); // Get full size
        const previewUrl = img.src;
        const title = img.alt || `${category}_${index}`;
        const itemId = extractIdFromUrl(img.src) || `${category}_${index}`;
        
        return {
            id: itemId,
            title: title.trim(),
            downloadUrl: downloadUrl,
            previewUrl: previewUrl,
            category: category
        };
    } catch (error) {
        console.error(`Error extracting image item ${index}:`, error);
        return null;
    }
}

function extractIdFromUrl(url) {
    if (!url) return '';
    
    const matches = url.match(/\/(\d+)[-_]/);
    return matches ? matches[1] : '';
}

function showScrapingProgress(message) {
    let progressEl = document.getElementById('pixabay-scraping-progress');
    
    if (!progressEl) {
        progressEl = document.createElement('div');
        progressEl.id = 'pixabay-scraping-progress';
        progressEl.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(75, 194, 75, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            backdrop-filter: blur(10px);
        `;
        document.body.appendChild(progressEl);
    }
    
    progressEl.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="
                width: 20px;
                height: 20px;
                border: 2px solid rgba(255,255,255,0.3);
                border-top: 2px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            "></div>
            ${message}
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
}

function hideScrapingProgress() {
    const progressEl = document.getElementById('pixabay-scraping-progress');
    if (progressEl) {
        progressEl.remove();
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeContentScript);
} else {
    initializeContentScript();
}

// Handle page navigation (for single-page app behavior)
let currentUrl = window.location.href;
setInterval(() => {
    if (window.location.href !== currentUrl) {
        currentUrl = window.location.href;
        isContentScriptActive = false;
        setTimeout(initializeContentScript, 1000);
    }
}, 1000);