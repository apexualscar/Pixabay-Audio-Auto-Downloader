// Background service worker for the Chrome extension
console.log('Pixabay Mass Downloader background script loaded');

// Listen for messages from content scripts
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
    if (message.action === 'START_DOWNLOAD') {
        handleDownloadRequest(message, sender.tab.id);
    }
});

async function handleDownloadRequest(request, tabId) {
    const { username, contentType, apiKey } = request;
    
    try {
        console.log(`Starting download for user: ${username}, type: ${contentType}`);
        
        // Get user's submissions from Pixabay API
        const submissions = await fetchUserSubmissions(username, contentType, apiKey);
        
        if (submissions.length === 0) {
            chrome.tabs.sendMessage(tabId, {
                action: 'DOWNLOAD_ERROR',
                error: 'No submissions found for this user and content type'
            });
            return;
        }
        
        // Download each submission
        let downloadedCount = 0;
        const totalCount = submissions.length;
        
        for (let i = 0; i < submissions.length; i++) {
            const submission = submissions[i];
            
            try {
                await downloadFile(submission, contentType);
                downloadedCount++;
                
                // Update progress
                chrome.tabs.sendMessage(tabId, {
                    action: 'UPDATE_PROGRESS',
                    current: downloadedCount,
                    total: totalCount
                });
                
                // Add small delay to avoid overwhelming the system
                await sleep(100);
                
            } catch (error) {
                console.error(`Failed to download ${submission.webformatURL}:`, error);
                // Continue with next file even if one fails
            }
        }
        
        // Notify completion
        chrome.tabs.sendMessage(tabId, {
            action: 'DOWNLOAD_COMPLETE',
            count: downloadedCount
        });
        
    } catch (error) {
        console.error('Download error:', error);
        chrome.tabs.sendMessage(tabId, {
            action: 'DOWNLOAD_ERROR',
            error: error.message
        });
    }
}

async function fetchUserSubmissions(username, contentType, apiKey) {
    const baseUrl = 'https://pixabay.com/api/';
    const submissions = [];
    let page = 1;
    const perPage = 200; // Maximum allowed by Pixabay API
    
    try {
        while (true) {
            const url = `${baseUrl}?key=${apiKey}&username=${encodeURIComponent(username)}&category=${contentType}&per_page=${perPage}&page=${page}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.hits.length === 0) {
                break; // No more results
            }
            
            submissions.push(...data.hits);
            
            // If we got less than perPage results, we've reached the end
            if (data.hits.length < perPage) {
                break;
            }
            
            page++;
            
            // Add small delay between API calls to be respectful
            await sleep(200);
        }
        
        return submissions;
        
    } catch (error) {
        console.error('Error fetching submissions:', error);
        throw error;
    }
}

async function downloadFile(submission, contentType) {
    // Determine the best download URL based on content type
    let downloadUrl;
    let filename;
    
    switch (contentType) {
        case 'photo':
            downloadUrl = submission.largeImageURL || submission.webformatURL;
            filename = `pixabay_image_${submission.id}.jpg`;
            break;
        case 'music':
            downloadUrl = submission.download_url; // For audio files
            filename = `pixabay_audio_${submission.id}.mp3`;
            break;
        case 'video':
            downloadUrl = submission.videos?.large?.url || submission.videos?.medium?.url;
            filename = `pixabay_video_${submission.id}.mp4`;
            break;
        default:
            downloadUrl = submission.webformatURL;
            filename = `pixabay_${contentType}_${submission.id}`;
    }
    
    if (!downloadUrl) {
        throw new Error('No download URL available for this submission');
    }
    
    // Use Chrome's downloads API
    return new Promise((resolve, reject) => {
        chrome.downloads.download({
            url: downloadUrl,
            filename: `pixabay_downloads/${filename}`,
            saveAs: false
        }, (downloadId) => {
            if (chrome.runtime.lastError) {
                reject(new Error(chrome.runtime.lastError.message));
            } else {
                resolve(downloadId);
            }
        });
    });
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Handle extension installation
chrome.runtime.onInstalled.addListener((details) => {
    if (details.reason === 'install') {
        console.log('Pixabay Mass Downloader installed');
        
        // Open options page or show welcome message
        chrome.tabs.create({
            url: chrome.runtime.getURL('popup.html')
        });
    }
});